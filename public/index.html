<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Refugee Data Visualizer</title>
    <style href="css/style.css">
      body {
        font-family: Helvetica, sans-serif;
      }
      .left-container {
        display: inline-block;
      }

      .middle-container {
        display: inline-block;
        position: absolute;
        height: 560px;
      }
      .map-container {
        position: relative;
      }
      .chart-container {
        position: relative;
        top: -39px;
      }
      .countries-container {
        -webkit-column-count: 2; /* Chrome, Safari, Opera */
        -moz-column-count: 2; /* Firefox */
        column-count: 2;
        height: 560px;
        overflow: scroll;
        width: 200px;
        display: inline-block;
      }

      .right-container {
        width: 200px;
        display: inline;
        float: right;
      }
      .bar {
        fill: rgba(0,0,0,0.5);
      }

      .bar:hover {
        fill: rgb(253,200,47);
      }

      .state:hover{
        fill: rgba(253,200,47, 0.5);
        text: "hi";
      }

      .country:hover{
        text-decoration: underline;
        cursor: default;
      }

      .axis {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .x.axis path {
        display: none;
      }

      .background {
      fill: none;
      pointer-events: all;
      }

      #states {
      fill: #333444;
      }

      #states .active {
      fill: rgb(253,200,47);
      }

      #state-borders {
      fill: none;
      stroke: #fff;
      stroke-width: 1.5px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
      }

      #title {
        margin-bottom: 10px;
        background-color: white;
        color: rgb(253,200,47);
      }

    </style>
  </head>
  <body>
    <header>
      <h1 id="title">Refugee Data Visualizer</h1>
    </header>
    <div class="overall-container">
      <div class="left-container">
        <div class="countries-container"></div>
      </div>

      <div class="middle-container">
        <div class="map-container"></div>
        <div class="chart-container"></div>
      </div>

      <div class="right-container">
        <div class="news-stats-container">
          <h3>Years</h2>
          <ul id="years-list">
          </ul>
        </div>
      </div>
    </div>

    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script src="topojson.v1.min.js"></script>
    <script>

    // i want hovering over the countries text to cause the map and the bar chart to update with the country number
    // how do i do this?  i figure i need an event broadcaster and an event listeners. event listeners need to be on the
    // bar chart and the map.  event broadcaster needs to be on each country item.
    ////////////////////////////////////////////////// VARIABLES //////////////////////////////////////////////////
    // var dispatch = d3.dispatch("load", "statechange");
    // var listOfWelcomingStates = ["ARIZONA", "FLORIDA", "GEORGIA", "IDAHO", "ILLINOIS", "IOWA", "MARYLAND", "MASSACHUSETTS",
    //                             "MICHIGAN", "NEW MEXICO", "NORTH CAROLINA", "NORTH DAKOTA", "OHIO", "OKLAHOMA", "TENNESSEE",
    //                             "TEXAS", "WISCONSIN"];
    var statesGeoArray = [];
    var drawnOrderStatesNameArray = ["WASHINGTON", "MONTANA", "IDAHO", "NORTH DAKOTA", "MINNESOTA", "MAINE",
                                    "MICHIGAN", "WISCONSIN", "OREGON", "SOUTH DAKOTA", "NEW HAMPSHIRE", "VERMONT",
                                    "NEW YORK", "WYOMING", "IOWA","NEBRASKA", "MASSACHUSETTS", "ILLINOIS", "PENNSYLVANIA",
                                    "CONNECTICUT", "RHODE ISLAND", "CALIFORNIA","UTAH", "NEVADA", "OHIO", "INDIANA",
                                    "NEW JERSEY","COLORADO","WEST VIRGINIA","MISSOURI", "KANSAS", "DELAWARE", "MARYLAND",
                                    "VIRGINIA","KENTUCKY", "DISTRICT OF COLUMBIA", "ARIZONA", "OKLAHOMA", "NEW MEXICO",
                                    "TENNESSEE", "NORTH CAROLINA", "TEXAS", "ARKANSAS","SOUTH CAROLINA", "ALABAMA","GEORGIA",
                                    "MISSISSIPPI","LOUISIANA","FLORIDA","HAWAII","ALASKA"];
    var drawnOrderStatesNumberArray = [47,26,12,34,23,19,22,49,37,41,29,45,32,50,15,27,21,13,38,6,39,4,44,28,35,14,30,5,48,25,
                                      16,7,20,46,17,8,2,36,31,42,33,43,3,40,0,10,24,18,9,11,1];

    // numbers of individuals per state from country for 2014_refugees
    var perStateFromcountry =[];
    var countriesArray = [];
    var statesArray = [];
    var country = 1;
    var arrayOfFiles = ["all","2016_refugees","2015_refugees","2014_refugees","2013_refugees", "2012_refugees"];
    var dataset = "2014_refugees";
    ////////////////////////////////////////////////// VARIABLES //////////////////////////////////////////////////

    ////////////////////////////////////////////////// DRAWING THE MAP //////////////////////////////////////////////////
    // Started with map and chart from http://bl.ocks.org/mbostock/
    // dispatch.on("load")
    var width = 860,
        height = 450,
        centered;

    var projection = d3.geo.albersUsa()
        .scale(900)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select(".map-container").append("svg")
        .attr("width", width)
        .attr("height", height);

    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height);


    var g = svg.append("g");
    var scaled = 0;

var drawmap = function () {
  d3.json("us-10m.json", function(error, us) {
    if (error) throw error;
    // console.log(us.objects.states.geometries[i].id);
    g.append("g")
        .attr("id", "states")
      .selectAll("path")
        .data(topojson.feature(us, us.objects.states).features)
      .enter().append("path")
        .attr("d", path)
        .attr("fill", function (d,i) {
          statesGeoArray.push(us.objects.states.geometries[i].id)
          //the drawn order array returns the index of the state
          //i want to scale the color based on number of individuals.  more indivduals should be higher in color, less should be lower in color
          scaled = d3.scale.linear().domain([0,d3.max(perStateFromcountry.slice(0,51))]).range([0,98]);
          return "hsl(45,"+scaled(perStateFromcountry.slice(0,51)[drawnOrderStatesNumberArray[i]]) + "%,59%)";
        })
        .on("mouseover", mousedover);

    g.append("path")
        .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .attr("id", "state-borders")
        .attr("d", path);
  });

}

drawmap();


    ////////////////////////////////////////////////// DRAWING THE MAP //////////////////////////////////////////////////


    ////////////////////////////////////////////////// COUNTRIES-LIST AND POPULATING ARRAYS //////////////////////////////////////////////////

    // getting data from json file, pushing data to arrays
    var populators = function() {
    d3.json(dataset+".json", function(error, data) {
        if (error) {
          // perStateFromcountry =[];
          return console.error(error);
        }
        ////////////////////////////////////////////////// COUNTRY AND ARRAY POPULATORS //////////////////////////////////////////////////
        var populateCountriesAndStates = function () {


        //for some reason this is not called again even though this function is triggered
        //var hi = d3.select(".countries-container").selectAll("span").data(data.Columns);

        data.Columns.forEach(function (d) {
          countriesArray.push(d);
        });

        data.Rows.forEach(function (d) {
          statesArray.push(d3.keys(d)[0]);
          console.log([d3.values(d)[0][country]]);
          perStateFromcountry.push(d3.values(d)[0][country])
        });
      }
      ////////////
      populateCountriesAndStates();
      ////////////////////////////////////////////////// COUNTRY AND ARRAY POPULATORS //////////////////////////////////////////////////
      ////////////////////////////////////////////////// COUNTRY TOGGLE //////////////////////////////////////////////////
      d3.select(".countries-container").selectAll("li")
      .data(data.Columns)
        .enter()
        .append("li")
        .text(function (d, i) {
          return countriesArray[i].toString().split(",").join(", ")
        })
        .style("font-size", "0.68em")
        .style("color", "grey")
        .style("list-style", "none")
        .on("click", function (d,i) {
          perStateFromcountry = [];
          d3.select(this).attr("class","country")
          country = i;
          populateCountriesAndStates();
          drawmap();
          d3.select(".chart-container>svg").remove();
          chartDraw();
        });
        ////////////////////////////////////////////////// COUNTRY TOGGLE //////////////////////////////////////////////////
    });
}
populators();

    var mousedover = function () {
      d3.select(this).attr("class", "state");
      //country = 2;
      // refillArray();

    }
    ////////////////////////////////////////////////// COUNTRIES-LIST AND POPULATING ARRAYS //////////////////////////////////////////////////

    ////////////////////////////////////////////////// BAR-CHART //////////////////////////////////////////////////
    var chartDraw = function () {
      var margin = {top: 20, right: 20, bottom: 80, left: 40},
          width = 830 - margin.left - margin.right,
          height = 180 - margin.top - margin.bottom;

      var x = d3.scale.ordinal()
          .rangeRoundBands([0, width], .1);
      var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

      var y = d3.scale.linear()
          .range([height, 0]);


      var yAxis = d3.svg.axis()
          .scale(y)
          .orient("left")
          .ticks(10);

      var svg = d3.select(".chart-container")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      d3.json(dataset+".json", function(error, data) {
        if (error) throw error;

        x.domain(statesArray.slice(0,51).map(function(d) { return d; }));
        y.domain([0, d3.max(perStateFromcountry.slice(0,51))]);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
              .selectAll("text")
              .style("text-anchor", "end")
              .style("font-size", "0.85em")
              .attr("dx", "-.7em")
              .attr("dy", "0em")
              .attr("transform", "rotate(-45)" );;

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .style("font-size", "1.0em")
            .text("People Resettled");

        svg.selectAll(".bar")
            .data(perStateFromcountry.slice(0,51))
          .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d,i) { return x(statesArray[i]); })
            .attr("width", x.rangeBand())
            .attr("y", function(d) { return y(d); })
            .attr("height", function(d) { return height - y(d); });
      });
    }
    chartDraw();
    ////////////////////////////////////////////////// BAR-CHART //////////////////////////////////////////////////
    ////////////////////////////////////////////////// YEAR TOGGLE //////////////////////////////////////////////////
    d3.select("#years-list").selectAll("li")
      .data(["All",2016,2015,2014,2013,2012])
      .enter()
        .append("li")
        .text(function (d,i) {
          return d;
        })
        .on("click", function (d,i) {
          console.log(d,i);
          console.log(dataset);
          console.log(arrayOfFiles[i]);
          dataset=arrayOfFiles[i];
          perStateFromcountry = [];
          country = 1;
          populators();
          d3.selectAll(".countries-container li").remove();
          drawmap();
          d3.select(".chart-container>svg").remove();
          chartDraw();
        })
    ////////////////////////////////////////////////// YEAR TOGGLE //////////////////////////////////////////////////


    </script>
  </body>
</html>
